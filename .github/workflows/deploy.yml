name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: Deployment target name
        required: true
        default: production
        type: choice
        options:
          - production
          - staging
      stack_name:
        description: CloudFormation stack name
        required: true
        default: sam-app
      aws_region:
        description: AWS region
        required: true
        default: us-east-1
      deploy_frontend:
        description: Sync app/ to S3 and invalidate CloudFront
        required: true
        default: false
        type: boolean
      enable_ops_monitoring:
        description: Create CloudWatch alarms/dashboard from template
        required: true
        default: false
        type: boolean
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || 'production' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ inputs.aws_region || 'us-east-1' }}

      - name: Set up SAM CLI
        uses: aws-actions/setup-sam@v2

      - name: Build
        run: sam build

      - name: Deploy backend
        env:
          ADMIN_KEY: ${{ secrets.ADMIN_KEY }}
          OPS_ALARM_EMAIL: ${{ secrets.OPS_ALARM_EMAIL }}
        run: |
          if [ -z "$ADMIN_KEY" ]; then
            echo "ADMIN_KEY secret is required"
            exit 1
          fi

          PARAM_OVERRIDES=(
            "AdminKey=$ADMIN_KEY"
            "EnableOpsMonitoring=${{ inputs.enable_ops_monitoring || 'false' }}"
          )

          if [ -n "$OPS_ALARM_EMAIL" ]; then
            PARAM_OVERRIDES+=("OpsAlarmEmail=$OPS_ALARM_EMAIL")
          fi

          sam deploy \
            --stack-name "${{ inputs.stack_name || 'sam-app' }}" \
            --region "${{ inputs.aws_region || 'us-east-1' }}" \
            --resolve-s3 \
            --capabilities CAPABILITY_IAM \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --parameter-overrides "${PARAM_OVERRIDES[@]}"

      - name: Deploy frontend assets
        if: ${{ inputs.deploy_frontend || github.event_name == 'push' }}
        env:
          SCRUMBLE_BUCKET: ${{ secrets.SCRUMBLE_BUCKET }}
          SCRUMBLE_CF_DISTRIBUTION_ID: ${{ secrets.SCRUMBLE_CF_DISTRIBUTION_ID }}
        run: |
          if [ -z "$SCRUMBLE_BUCKET" ]; then
            echo "SCRUMBLE_BUCKET secret is required when deploy_frontend=true"
            exit 1
          fi

          aws s3 sync app/ "s3://${SCRUMBLE_BUCKET}/" --delete --exclude "*" --include "*.html" --cache-control "max-age=3600" --exclude ".DS_Store"
          aws s3 sync app/ "s3://${SCRUMBLE_BUCKET}/" --exclude "*.html" --cache-control "max-age=31536000" --exclude ".DS_Store"

          if [ -n "$SCRUMBLE_CF_DISTRIBUTION_ID" ]; then
            aws cloudfront create-invalidation --distribution-id "$SCRUMBLE_CF_DISTRIBUTION_ID" --paths "/*"
          fi
